sudo: required
dist: trusty
language: python
services:
  - docker
env:
  global:
    - DOCKER_USERNAME=vanvalenlabrobot
    - secure: "I1FHCpBQlD1M1ngrgF5iEIrPiICRUBSvBQHAJFSxrpgJtxtrfx3nc/xFMylwzT9CEDmnvDVbM1VWNDixYT+O0fkyUptBPNYlLc19FgRvpj7JdFSzOaRA+2jKCMX6FiqQBsuNieAZfAF0XmDc3HE1Rgl6KdVAHZGzZ14jIIx2hepqjKCTMsRYJyyNm70cd1g1mzzxCPT6YpEAKxQaFqdSLz289Las3XtF1PLlfV+sWQaTl+ZvlVfLGigjPtxWoDcoJcpVj3SLL41IufV9L87NCaEBOD8/wq02YJo+R4lZ+2WL0RuW5dBDL0TBoi+HiaYb0oE6PI/JgfZhviuer3d/2/175LDW43UBfv6JNq1foplS8h2MxfRg2Sl2HyiAey1kbovycHHf/bc9/rvswkxiG7EV+iCzKUT9OgdZPovI9Ci24Q1PQ5JMSY4o47sJBXhahp5a2X8CCDJ9C3ydmzAe9sNb0CWwbg28EgIIZ6DL/a04CBeS2E94dQEwDeBv5gCbmiLjFqyZthImIgCEuUuA8AAFM0ZWblzR0RnvW6P85EPxIJ9Ep3PeoVeiTbC2SmS3fFXDfeHkhuh3R3nH9QYMHOOA+9THSedP55fZgo9ADFcDfjairsD4xZAz+cTiH/FQNoBLcrMQ4xQ0dcUdzY1EogQs5b+5yOPlz5FV6GNjJws="
matrix:
  include:
    - python: 3.5
      env: TF_VERSION=1.8.0
    - python: 3.5
      env: TF_VERSION=1.9.0
    - python: 3.5
      env: TF_VERSION=1.10.0
    - python: 3.5
      env: TF_VERSION=1.11.0
    - python: 3.5
      env: TF_VERSION=1.12.0
install:
  # source: http://conda.pydata.org/docs/travis.html
  # We do this conditionally because it saves us some downloading if the
  # version is the same.
  - if [[ "$TRAVIS_PYTHON_VERSION" == "2.7" ]]; then
      wget https://repo.continuum.io/miniconda/Miniconda-latest-Linux-x86_64.sh -O miniconda.sh;
    else
      wget https://repo.continuum.io/miniconda/Miniconda3-latest-Linux-x86_64.sh -O miniconda.sh;
    fi

  - bash miniconda.sh -b -p $HOME/miniconda
  - export PATH="$HOME/miniconda/bin:$PATH"
  - hash -r
  - conda config --set always_yes yes --set changeps1 no
  - conda update -q conda
  # Useful for debugging any issues with conda
  - conda info -a

  - conda create -q -n test-environment python=$TRAVIS_PYTHON_VERSION numpy pytest
  - source activate test-environment
  - pip install pytest pytest-pep8 pytest-cov coveralls
  - pip install matplotlib nbformat scipy numpy pandas scikit-learn scikit-image
  # install TensorFlow (CPU version).
  - pip install tensorflow==$TF_VERSION
  # install fizyr packages for retinanet and maskrcnn
  - pip install keras-retinanet opencv-python
  - pip install git+git://github.com/fizyr/keras-maskrcnn.git@fa3d7f8e81d0ffb036fde5e134dcdbf35c206fc1
  - python setup.py install

  # set library path
  - export LD_LIBRARY_PATH=$HOME/miniconda/envs/test-environment/lib/:$LD_LIBRARY_PATH

# command to run tests
script:
  - PYTHONPATH=$PWD:$PYTHONPATH python -m pytest --cov=deepcell --pep8 deepcell tests
after_success:
  - coveralls
  - if [[ "$TRAVIS_BRANCH" == "travis-cd" ]]; then
      docker login -u $DOCKER_USERNAME -p $DOCKER_PASSWORD ;
      docker build --pull --cache-from "$IMAGE_NAME" --tag "$IMAGE_NAME" . ;
      docker tag "$IMAGE_NAME" "${IMAGE_NAME}:latest"
      docker tag "$IMAGE_NAME" "${IMAGE_NAME}:${version}"
      docker push "${IMAGE_NAME}:latest" && docker push "${IMAGE_NAME}:${version}"
    fi
